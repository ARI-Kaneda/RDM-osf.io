{% extends "base.html" %}
{% load i18n %}
{% load render_bundle from webpack_loader %}
{% load spam_extras %}
{% load static %}

{% block top_includes %}
    <link rel="stylesheet" type="text/css" href="/static/css/institutions.css"/>
{% endblock %}

{% block title %}
    <title>{% trans "List of Entitlements" %}</title>
{% endblock title %}

{% block content %}
    <div id="error_message" class="row hidden"></div>
    <h2>{% trans "Entitlements" %}</h2>

    <form onsubmit="check_entitlement(event)" action="{% url "entitlements:bulk_add" %}" method="post" class="form-horizontal" id="entitlements_form">
        {% csrf_token %}
        <div class="form-group">
            <label for="institution_id" class="col-sm-2 control-label">Institution</label>
            <div class="col-sm-4">
                <select id="institution_id" name="institution_id" class="form-control">
                    {% for institution in institutions %}
                        <option value="{{ institution.id }}" {% if selected_id == institution.id %}selected="selected"{% endif %}>{{ institution.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="entitlements" class="col-sm-2 control-label">Entitlements</label>
            <div class="form-inline col-sm-4" id="entitlements_block">
                <div class="clearfix" style="margin-bottom: 15px;">
                    <div class="input-group">
                        <input type="text" name="entitlements" placeholder="Enter new entitlement"
                               class="form-control">
                    </div>
                    <div class="input-group form-check">
                        <input type="checkbox" name="login_availability" checked="checked" value="on"
                               onchange="{this.classList.toggle('checked'); this.value = this.classList.contains('checked') ? 'on' : 'off'; this.checked= true;}"
                               data-toggle="toggle" data-onstyle="success" class="btn apple-switch checked">
                        <label class="form-check-label" for="login_availability">login availability</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="button" class="btn btn-default" onclick="new_entitlement_element()">{% trans 'New entitlement' %}</button>
                <button type="submit" class="btn btn-primary" style="width: 90px;">{% trans 'Save' %}</button>
            </div>
        </div>
    </form>
    <script type="application/javascript">
        document.getElementById("institution_id").addEventListener("change", function change_institution() {
            window.location = window.location.origin + "{% url 'institutions:entitlements' %}" + '?institution_id=' + document.getElementById("institution_id").value;
        });

        function new_entitlement_element() {
            let entitlements_html = `<div class="clearfix" style="margin-bottom: 15px;"> <div class="input-group"> <input type="text" name="entitlements" placeholder="Enter new entitlement" class="form-control"> </div>
            <div class="input-group form-check"> <input type="checkbox" name="login_availability" checked="checked" value="on"
            onchange="{this.classList.toggle('checked'); this.value = this.classList.contains('checked') ? 'on' : 'off'; this.checked= true;}" data-toggle="toggle" data-onstyle="success" class="btn apple-switch checked"> <label class="form-check-label" for="login_availability">login availability</label> </div> </div>`;
            document.getElementById("entitlements_block").append(new DOMParser().parseFromString(entitlements_html, 'text/html').body.childNodes[0])
        }

       function check_entitlement(event){
            let element = document.getElementById("error_message");
            let entitlement_input = document.getElementsByName("entitlements")[0].value;
            if (entitlement_input.length === 0 || entitlement_input.trim() === ""){
                 event.preventDefault();
                 let message = "Entitlement is not empty";
                 element.classList.remove("hidden");
                 document.getElementById("error_message").innerHTML = "<ul><li>" + message + "</li></ul>";
            }
            else {
                let entitlements = [];
                let table = document.getElementsByTagName("table")[0];
                let rows = table.rows;
                for (let i = 0; i < rows.length; i++) {
                    let cellValue = rows[i].cells[0].firstChild.nodeValue;
                    entitlements.push(cellValue.trim());
                }
                if (entitlements.includes(entitlement_input.trim())) {
                    event.preventDefault();
                    let message = "Entitlement already exists";
                    element.classList.remove("hidden");
                    document.getElementById("error_message").innerHTML = "<ul><li>" + message + "</li></ul>";
                }
            }
        }
    </script>

    {% include "entitlements/pagination.html" with institution_id=selected_id items=page status=status %}

    <table class="table table-striped table-hover table-responsive">
        <thead></thead>
        <tbody>
        {% for entitlement in entitlements %}
            <tr>
                <td>{{ entitlement.entitlement }}</td>
                <td>
                    <input type="checkbox"
                           {% if entitlement.login_availability %}checked="checked"{% endif %}
                           value="{% if entitlement.login_availability %}on{% else %}off{% endif %}"
                            class="btn apple-switch {% if entitlement.login_availability %}checked{% endif %}"
                           onchange="{$('#toggle_entitlement_{{ entitlement.id }}').submit()}"
                           data-toggle="toggle" data-onstyle="success">
                    <form id="toggle_entitlement_{{ entitlement.id }}" method="POST" action="{% url 'institutions:entitlement_toggle' selected_id entitlement.id %}">{% csrf_token %}</form>
                </td>
                <td>
                    <a class="btn btn-primary"
                       onclick="{$('#delete_entitlement_{{ entitlement.id }}').submit()}">
                        Delete
                    </a>
                    <form id="delete_entitlement_{{ entitlement.id }}" method="POST" action="{% url 'institutions:entitlement_delete' selected_id entitlement.id %}">{% csrf_token %}</form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

{% endblock content %}

{% block bottom_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">\x3C/script>')</script>
{% endblock %}
