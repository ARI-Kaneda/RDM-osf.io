{% extends "base.html" %}
{% load i18n %}
{% load render_bundle from webpack_loader %}
{% load spam_extras %}
{% load static %}

{% block top_includes %}
    <link rel="stylesheet" type="text/css" href="/static/css/institutions.css"/>
{% endblock %}

{% block title %}
    <title>{% trans "List of Entitlements" %}</title>
{% endblock title %}

{% block content %}
    <h2>{% trans "Entitlements" %}</h2>

    <div class="row">
        <div id="error_message" class="col-md-12">
            {% if request.session.message %}
                <div class="alert alert-danger">
                    {{ request.session.message }}
                </div>
            {% endif %}
        </div>
    </div>
    <form action="{% url "entitlements:bulk_add" %}" method="post" class="form-horizontal"
          onsubmit="check_entitlements(event)"
          id="entitlements_form">
        {% csrf_token %}
        <div class="form-group">
            <label for="institution_id" class="col-sm-2 control-label">Institution</label>
            <div class="col-sm-4">
                <select id="institution_id" name="institution_id" class="form-control">
                    {% for institution in institutions %}
                        <option value="{{ institution.id }}" {% if selected_id == institution.id %}selected="selected"{% endif %}>{{ institution.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="entitlements" class="col-sm-2 control-label">Entitlements</label>
            <div class="form-inline col-sm-4" id="entitlements_block" style="max-height: 132px; overflow: auto;">
                <div class="clearfix" style="margin-bottom: 15px;">
                    <div class="input-group">
                        <input type="text" name="entitlements" placeholder="Enter new entitlement"
                               minlength="1" maxlength="255"
                               class="form-control">
                    </div>
                    <div class="input-group form-check">
                        <input type="checkbox" name="login_availability" checked="checked" value="on"
                               onchange="{this.classList.toggle('checked'); this.value = this.classList.contains('checked') ? 'on' : 'off'; this.checked= true;}"
                               data-toggle="toggle" data-onstyle="success" class="btn apple-switch checked">
                        <label class="form-check-label" for="login_availability" style="padding-left: 15px;">login availability</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="button" class="btn btn-default" onclick="new_entitlement_element()">{% trans 'New entitlement' %}</button>
                <button type="submit" class="btn btn-primary" style="width: 90px;">{% trans 'Save' %}</button>
            </div>
        </div>
    </form>
    {% include "entitlements/pagination.html" with institution_id=selected_id items=page status=status %}

    <table class="table table-striped table-hover table-responsive">
        <thead></thead>
        <tbody>
        {% for entitlement in entitlements %}
            <tr>
                <td class="entitlement current">{{ entitlement.entitlement }}</td>
                <td>
                    <input type="checkbox"
                           {% if entitlement.login_availability %}checked="checked"{% endif %}
                           value="{% if entitlement.login_availability %}on{% else %}off{% endif %}"
                           class="btn apple-switch {% if entitlement.login_availability %}checked{% endif %}"
                           onchange="{$('#toggle_entitlement_{{ entitlement.id }}').submit()}"
                           data-toggle="toggle" data-onstyle="success">
                    <form id="toggle_entitlement_{{ entitlement.id }}" method="POST" action="{% url 'institutions:entitlement_toggle' selected_id entitlement.id %}?page={{ request.GET.page }}">{% csrf_token %}</form>
                </td>
                <td>
                    <a class="btn btn-primary"
                       onclick="{$('#delete_entitlement_{{ entitlement.id }}').submit()}">
                        Delete
                    </a>
                    <form id="delete_entitlement_{{ entitlement.id }}" method="POST" action="{% url 'institutions:entitlement_delete' selected_id entitlement.id %}?page={{ request.GET.page }}">{% csrf_token %}</form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

{% endblock content %}

{% block bottom_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">\x3C/script>')</script>
    <script type="application/javascript">
        document.getElementById("institution_id").addEventListener("change", function change_institution() {
            window.location = window.location.origin + "{% url 'institutions:entitlements' %}" + '?institution_id=' + document.getElementById("institution_id").value;
        });

        function new_entitlement_element() {
            let entitlements_html = `<div class="clearfix" style="margin-bottom: 15px;"> <div class="input-group">
            <input type="text" name="entitlements" placeholder="Enter new entitlement" minlength="1" maxlength="255" class="form-control"> </div>
            <div class="input-group form-check"> <input type="checkbox" name="login_availability" checked="checked" value="on"
            onchange="{this.classList.toggle('checked'); this.value = this.classList.contains('checked') ? 'on' : 'off'; this.checked= true;}"
            data-toggle="toggle" data-onstyle="success" class="btn apple-switch checked"> <label class="form-check-label" for="login_availability"
            style="padding-left: 15px;">login availability</label> </div> </div>`;
            document.getElementById("entitlements_block").append(new DOMParser().parseFromString(entitlements_html, 'text/html').body.childNodes[0])
        }

        function check_entitlements(event) {
            $(".alert").remove();
            let message = undefined;
            let input_entitlements = [];
            let current_entitlements = [];
            $(".entitlement.current").each(function (index, element) {
                current_entitlements.push($(element).text());
            });
            for (let i = 0; i < $("[name='entitlements']").length; i++) {
                let entitlement = $($("[name='entitlements']")[i]);
                let entitlement_input = entitlement.val().trim();
                if (!entitlement_input.length) {
                    message = "Entitlement must be not empty";
                    entitlement.val('').focus();
                    break;
                } else if (current_entitlements.includes(entitlement_input)) {
                    message = "Entitlement '" + entitlement_input + "' already exists";
                    entitlement.val('').focus();
                    break;
                } else if (input_entitlements.includes(entitlement_input)) {
                    message = "Entitlement '" + entitlement_input + "' have been inputed";
                    entitlement.val('').focus();
                    break;
                } else {
                    input_entitlements.push(entitlement_input);
                }
            }
            let alert_html = !!message ? ("<div class='alert alert-danger'>" + message + "</div>") : undefined;
            if (!!alert_html) {
                event.preventDefault();
                $("#error_message").append(new DOMParser().parseFromString(alert_html, 'text/html').body.childNodes[0]);
            }
        }
    </script>
{% endblock %}
