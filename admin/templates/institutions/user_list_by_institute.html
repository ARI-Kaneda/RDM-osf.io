{% load i18n %}
<h2 id="title">{% trans "Statistical Status of NII Storage" %}</h2>
<h3 id="sub-title">{% blocktrans %}NII Storage > {{ institution_name }}{% endblocktrans %}</h3>

<div class="form-row justify-content-between">
    <div style="margin: 20px 0">
        <a class="btn btn-primary" href="{% url 'institutions:tsvexport' institution_id %}">{% trans "Export All Users Statistics (TSV)" %}</a>
    </div>
</div>

<style type="text/css">
    .w-search-input {
        width: 6em !important;
        max-width: 16em !important;
    }

    .form-group.flex-item {
        max-width: 20em !important;
    }

    .flex-container,
    .flex-container .form-group.flex-item {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        align-items: baseline;
    }

    .form-group.flex-item .w-search-input,
    .flex-container .flex-item {
        flex-grow: 1;
        flex-shrink: 1;
        flex-basis: 0%;
        white-space: nowrap;
        margin-left: 2px;
        margin-right: 2px;
    }

    @media (max-width: 768px) {
        .w-search-input {
            width: auto !important;
        }

        .flex-container {
            flex-direction: column;
            flex-wrap: wrap;
        }

        .form-group.flex-item label {
            width: 5em;
            flex-grow: 1;
        }
    }
</style>
<form class="form-inline flex-container"
      action="{% url 'institutions:institution_user_list' institution_id %}" method="get"
      onsubmit="return validateForm()">
    <div class="form-group flex-item">
        <label>{% trans "GUID" %}</label>
        <input name="guid" type="text" class="form-control w-search-input"
               placeholder="abcde"
               value="{{ request.GET.guid }}"
               maxlength="5" minlength="5"
               pattern="[0-9a-z]{5}"
               title="{% trans 'Please enter only contain alphanumeric in lowercase' %}"
               id="id_guid">
    </div>
    <div class="form-group flex-item" style="flex-grow: 3;">
        <label>{% trans "EmailLabel" %}</label>
        <input name="email" type="email" class="form-control w-search-input"
               placeholder="john@example.com"
               value="{{ request.GET.email }}"
               oninvalid="this.setCustomValidity({% trans 'Please enter an valid email' %})"
               oninput="setCustomValidity('')"
               maxlength="255" minlength="6"
               pattern="^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$"
               title="{% trans 'Please enter an email address' %}"
               id="id_email">
    </div>
    <div class="form-group flex-item" style="flex-grow: 2;">
        <label>{% trans "InfoLabel" %}</label>
        <input name="info" type="text" class="form-control w-search-input"
               placeholder="john"
               value="{{ request.GET.info }}"
               maxlength="255"
               id="id_name">
    </div>
    <div class="form-group flex-item" style="flex-grow: 0;">
        <button class="btn btn-primary" type="submit">{% trans 'Search' %}</button>
    </div>
</form>

{% include "util/pagination.html" with items=page status=direction order=order_by %}
<table class="table table-striped table-hover table-responsive">
    <thead>
        <tr>
            <th>GUID</th>
            <th>
                {% trans "Username" %}
                <a href="?order_by=username&amp;status=desc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a>
                <span class="dropup"><a href="?order_by=username&amp;status=asc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a></span>
            </th>
            <th>
                {% trans "Fullname" %}
                <a href="?order_by=fullname&amp;status=desc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a>
                <span class="dropup"><a href="?order_by=fullname&amp;status=asc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a></span>
            </th>
            <th>
                {% trans "Ratio" %}
                <a href="?order_by=ratio&amp;status=desc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a>
                <span class="dropup"><a href="?order_by=ratio&amp;status=asc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a></span>
            </th>
            <th>
                {% trans "Usage" %}
                <a href="?order_by=usage&amp;status=desc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a>
                <span class="dropup"><a href="?order_by=usage&amp;status=asc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a></span>
            </th>
            <th>
                {% trans "Remaining" %}
                <a href="?order_by=remaining&amp;status=desc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a>
                <span class="dropup"><a href="?order_by=remaining&amp;status=asc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a></span>
            </th>
            <th>
                {% trans "Quota" %}
                <a href="?order_by=quota&amp;status=desc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a>
                <span class="dropup"><a href="?order_by=quota&amp;status=asc&amp;page={{page.number}}" class="caret caret-sort tb-sort-inactive"></a></span>
            </th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>
                <a href="{%  url 'users:user' user.id %}"
                   class="btn btn-primary">
                    {{ user.id }}
                </a>
            </td>
            <td>{{user.username}}</td>
            <td>{{user.fullname}}</td>
            <td>{{user.ratio|floatformat:1}}%</td>
            <td>{{user.usage_value|floatformat:1}} {{user.usage_abbr}}</td>
            <td>{{user.remaining_value|floatformat:1}} {{user.remaining_abbr}}</td>
            <td>{{user.quota}} GB</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="/static/js/carets.js"></script>
<script>
    function validateForm() {
        let $id_guid = $('#id_guid');
        let $id_email = $('#id_email');
        let $id_name = $('#id_name');
        let id_guid = $id_guid.val().trim();
        let id_email = $id_email.val().trim();
        let id_name = $id_name.val().trim();
        console.log(!id_guid, !id_email, !id_name);
        !id_guid && $id_guid.val('').focus();
        !id_email && $id_email.val('').focus();
        !id_name && $id_name.val('').focus();

        return !!id_guid || (!!id_name && id_name.length <= 255) || !!id_email;
    }
</script>
